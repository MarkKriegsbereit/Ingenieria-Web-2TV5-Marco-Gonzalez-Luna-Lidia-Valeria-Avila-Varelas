{% extends "base.html" %}

{% block title %}Monitor de Vuelo (Invitado){% endblock %}

{% block content %}

<style>
    /* === ESTILOS VISUALES (Idénticos al Admin) === */
    
    /* Status Bar (Solo informativa) */
    .status-bar { 
        width: 100%; 
        background: #000; 
        color: #0f0; 
        font-family: monospace; 
        padding: 10px; 
        margin-bottom: 20px; 
        border-radius: 5px; 
        text-align: center; 
        border: 1px solid #333;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
    }

    /* Layout Flexible */
    .flex-container { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: space-between; 
        gap: 20px; 
        margin-bottom: 30px; 
    }
    
    .item { 
        background-color: rgba(20, 20, 20, 0.85); 
        border: 1px solid #333; 
        border-radius: 10px; 
        padding: 20px; 
        flex: 1; 
        min-width: 300px; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }

    /* === TAMAÑOS DE GRÁFICAS === */
    .donutBox { 
        width: 23%;      
        height: 160px;   
        position: relative; 
        text-align: center; 
        margin-bottom: 0; 
    }

    .chartBox { 
        width: 24%; 
        height: 180px;   
        position: relative; 
        text-align: center; 
        overflow: hidden; 
    }
    
    canvas { width: 100% !important; height: 100% !important; }

    /* Textos */
    .coorBox { display: flex; justify-content: space-between; width: 100%; border-bottom: 1px solid #444; padding: 5px 0; font-size: 1rem; }
    h4 { color: #8A2BE2; margin-bottom: 5px; font-family: 'Orbitron'; font-size: 0.85rem; }
    h3 { color: #bbb; margin-bottom: 10px; font-family: 'Orbitron'; font-size: 1rem; }
    h2 { color: white; font-family: 'Orbitron'; font-size: 1.4rem; margin: 0;}
    p { color: white; font-family: 'Roboto'; margin: 0;}
    
    hr { margin: 15px 0; width: 100%; border-color: #444; }
</style>

<div class="dashboard-card" style="max-width: 100%; padding: 15px; margin-top: 80px; background: transparent; box-shadow: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="text-shadow: 0 0 15px #8A2BE2;">MONITOR DE VUELO (MODO ESPECTADOR)</h2>
    </div>
    <div class="status-bar" id="statusMsg">Esperando datos de telemetría del servidor...</div>
</div>

<div class="flex-container">
    
    <div class="item" style="flex: 0 0 55%; display: flex; flex-direction: column;">
        <h3 style="border-bottom: 1px solid #444; width: 100%; text-align: center; padding-bottom: 5px; margin-bottom: 0;">AMBIENTE</h3>
        <div style="display: flex; width: 100%; justify-content: space-between; align-items: center; flex-grow: 1;">
            <div class="donutBox"><h4>Temp(C°)</h4><canvas id="myChart5"></canvas></div>
            <div class="donutBox"><h4>Hum(%)</h4><canvas id="myChart6"></canvas></div>
            <div class="donutBox"><h4>Pres(hPa)</h4><canvas id="myChart7"></canvas></div>
            <div class="donutBox"><h4>CO2(ppm)</h4><canvas id="myChart8"></canvas></div>
        </div>
    </div>
    
    <div class="item" style="flex: 1;">
        <h3 style="border-bottom: 1px solid #444; width: 100%; text-align: center; padding-bottom: 5px;">ESTADO DE VUELO</h3>
        <div style="display: flex; width: 100%; gap: 20px; margin-bottom: 10px;">
            <div style="width: 50%;">
                <div class="coorBox"><p>Apogeo:</p><p id="p-apo">0 m</p></div>
                <div class="coorBox"><p>Evento 1:</p><p id="p-arr">---</p></div>
                <div class="coorBox"><p>Evento 2:</p><p id="p-mai">---</p></div>
            </div>
            <div style="width: 50%;">
                <div class="coorBox"><p>LATITUD:</p><p id="plat">0.000</p></div>
                <div class="coorBox"><p>LONGITUD:</p><p id="plon">0.000</p></div>
            </div>
        </div>
        <div class="lineBox" style="width:100%; height: 200px; margin-top: 5px;">
            <canvas id="myChart9"></canvas>
        </div>
    </div>
</div>

<div class="flex-container">
    <div class="item" style="flex-direction: row; justify-content: space-around; padding: 10px;">
        <div class="chartBox"><h3>Velocidad (m/s)</h3><canvas id="myChart"></canvas></div>
        <div class="chartBox"><h3>Vel. Angular</h3><canvas id="myChart2"></canvas></div>
        <div class="chartBox"><h3>Aceleración</h3><canvas id="myChart3"></canvas></div>
        <div class="chartBox"><h3>Acel. Angular</h3><canvas id="myChart4"></canvas></div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

<script>
    var socket = io();

    // Solo escuchamos mensajes de estado, no enviamos nada.
    socket.on('status_msg', function(data) {
        const barra = document.getElementById('statusMsg');
        barra.innerText = ">> ESTADO DEL SERVIDOR: " + data.msg;
    });

    // --- CONFIGURACIÓN DE GRÁFICAS (Exactamente igual al Admin) ---
    const gaugeChartText = {
        id: 'gaugeChartText',
        afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            const score = data.datasets[0].data[0];
            const x = chart.getDatasetMeta(0).data[0].x;
            const y = chart.getDatasetMeta(0).data[0].y;
            ctx.font = 'bold 16px Orbitron'; 
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText(score, x, y - 20); // Posición ajustada
            ctx.restore();
        }
    };

    const gaugeChartText2 = {
        id: 'gaugeChartText2',
        afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            const score = data.datasets[0].data[0];
            const x = chart.getDatasetMeta(0).data[0].x;
            const y = chart.getDatasetMeta(0).data[0].y;
            ctx.font = 'bold 16px Orbitron'; 
            ctx.fillStyle = '#ccc';
            ctx.textAlign = 'center';
            ctx.fillText(score, x, y + 5);
            ctx.restore();
        }
    };

    const ctxTemp = document.createElement('canvas').getContext('2d');
    const gradient = ctxTemp.createLinearGradient(0, 0, 100, 0);
    gradient.addColorStop(0, '#E6E6FA');
    gradient.addColorStop(0.5, '#8A2BE2');
    gradient.addColorStop(1, '#4B0082');

    function createData(label, value, total, circumference, rotation) {
        return {
            labels: [label, 'Empty'],
            datasets: [{
                data: [value, total - value],
                backgroundColor: [gradient, 'rgba(255, 255, 255, 0.1)'],
                borderWidth: 0,
                cutout: '75%', circumference: circumference, rotation: rotation, borderRadius: 5
            }]
        };
    }

    function config(data, plugin) {
        return {
            type: 'doughnut', data: data,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { duration: 0 }, layout: { padding: 10 }
            }, plugins: [plugin]
        };
    }

    const myChart  = new Chart(document.getElementById('myChart'),  config(createData('Speed', 0, 100, 180, 270), gaugeChartText));
    const myChart2 = new Chart(document.getElementById('myChart2'), config(createData('AngSpeed', 0, 100, 180, 270), gaugeChartText));
    const myChart3 = new Chart(document.getElementById('myChart3'), config(createData('Accel', 0, 100, 180, 270), gaugeChartText));
    const myChart4 = new Chart(document.getElementById('myChart4'), config(createData('AngAccel', 0, 100, 180, 270), gaugeChartText));
    const myChart5 = new Chart(document.getElementById('myChart5'), config(createData('Temp', 0, 50, 360, 0), gaugeChartText2));
    const myChart6 = new Chart(document.getElementById('myChart6'), config(createData('Hum', 0, 100, 360, 0), gaugeChartText2));
    const myChart7 = new Chart(document.getElementById('myChart7'), config(createData('Press', 0, 1100, 360, 0), gaugeChartText2));
    const myChart8 = new Chart(document.getElementById('myChart8'), config(createData('CO2', 0, 1000, 360, 0), gaugeChartText2));

    const myChart9 = new Chart(document.getElementById('myChart9'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Altitud', data: [], borderColor: '#8A2BE2', backgroundColor: 'rgba(138, 43, 226, 0.2)',
                borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { display: false }, y: { ticks: { color: '#ccc', font: {size: 10} }, grid: { color: '#333' } } },
            plugins: { legend: { display: false } }, animation: { duration: 0 }
        }
    });

    // --- ACTUALIZACIÓN DE DATOS ---
    function updateDonut(chart, value, total) {
        chart.data.datasets[0].data = [value, total - value];
        chart.update('none');
    }
    function updateLine(chart, label, value) {
        if (chart.data.labels.length > 50) {
            chart.data.labels.shift(); chart.data.datasets[0].data.shift();
        }
        chart.data.labels.push(label); chart.data.datasets[0].data.push(value);
        chart.update('none');
    }

    socket.on('telemetria', function(trama) {
        if(trama.latitud) document.getElementById('plat').textContent = trama.latitud.toFixed(5);
        if(trama.longitud) document.getElementById('plon').textContent = trama.longitud.toFixed(5);
        if(trama.apogeo) document.getElementById('p-apo').textContent = trama.apogeo + ' m';

        const pArr = document.getElementById('p-arr');
        if(trama.evento_1 !== undefined) {
            pArr.textContent = trama.evento_1 ? "ACTIVO" : "---";
            pArr.style.color = trama.evento_1 ? "#00FF00" : "#FFFFFF"; 
        }
        const pMai = document.getElementById('p-mai');
        if(trama.evento_2 !== undefined) {
            pMai.textContent = trama.evento_2 ? "ACTIVO" : "---";
            pMai.style.color = trama.evento_2 ? "#FF4500" : "#FFFFFF";
        }

        if(trama.velocidad !== undefined) updateDonut(myChart, trama.velocidad, 100);
        if(trama.velocidad_ang !== undefined) updateDonut(myChart2, trama.velocidad_ang, 100);
        if(trama.aceleracion !== undefined) updateDonut(myChart3, trama.aceleracion, 100);
        if(trama.aceleracion_ang !== undefined) updateDonut(myChart4, trama.aceleracion_ang, 100);
        if(trama.temperatura !== undefined) updateDonut(myChart5, trama.temperatura, 50);
        if(trama.humedad !== undefined) updateDonut(myChart6, trama.humedad, 100);
        if(trama.presion !== undefined) updateDonut(myChart7, trama.presion, 1200);
        if(trama.co2 !== undefined) updateDonut(myChart8, trama.co2, 1000);

        if(trama.altitud !== undefined) {
            const timeLabel = new Date().toLocaleTimeString().split(' ')[0];
            updateLine(myChart9, timeLabel, trama.altitud);
        }
    });
</script>
{% endblock %}