{% extends "base.html" %}
{% block title %}Misi√≥n: {{ mision.Nombre_Mision }}{% endblock %}

{% block content %}
<style>
    /* === ESTILOS === */
    .control-panel { background-color: #111; border: 1px solid #8A2BE2; padding: 15px; margin-bottom: 20px; border-radius: 10px; display: flex; gap: 20px; align-items: center; justify-content: center; flex-wrap: wrap; }
    .status-bar { width: 100%; background: #000; color: #0f0; font-family: monospace; padding: 5px 10px; margin-top: 10px; border-radius: 5px; text-align: center; }
    .flex-container { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
    .item { background-color: rgba(20, 20, 20, 0.85); border: 1px solid #333; border-radius: 10px; padding: 20px; flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
    .donutBox { width: 23%; height: 160px; position: relative; text-align: center; margin-bottom: 0; }
    .chartBox { width: 24%; height: 180px; position: relative; text-align: center; overflow: hidden; }
    canvas { width: 100% !important; height: 100% !important; }
    .coorBox { display: flex; justify-content: space-between; width: 100%; border-bottom: 1px solid #444; padding: 5px 0; font-size: 1rem; }
    h4 { color: #8A2BE2; margin-bottom: 5px; font-family: 'Orbitron'; font-size: 0.85rem; }
    h3 { color: #bbb; margin-bottom: 10px; font-family: 'Orbitron'; font-size: 1rem; }
    h2 { color: white; font-family: 'Orbitron'; font-size: 1.4rem; margin: 0;}
    p { color: white; font-family: 'Roboto'; margin: 0;}
    #debugInfo { font-size: 0.7rem; color: #555; margin-top: 5px; }
    .error-msg { color: red; font-weight: bold; font-size: 0.8rem; display: none; }
    
    /* Botones */
    .btn-ctrl { padding: 8px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-family: 'Orbitron'; font-size: 0.9rem;}
    .btn-start { background: #28a745; }
    .btn-stop { background: #dc3545; display: none; }
</style>




<div class="dashboard-card" style="max-width: 100%; padding: 15px; margin-top: 80px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="color: white; font-family: 'Orbitron'; margin: 0;">{{ mision.Nombre_Mision }}</h2>
            <p style="color: #888; margin: 0; font-size: 0.9rem;">ID Sala: {{ mision.ID_Mision }} | {{ mision.Lugar }}</p>
            <div id="debugInfo">Inicializando...</div>
        </div>
        <div class="status-bar" id="statusMsg" style="width: auto;">Conectando...</div>
    </div>

    {% if es_admin %}
    <div class="control-panel">
        <label style="color: #8A2BE2; font-family: 'Orbitron';">BROADCASTER:</label>
        <select id="comPort" style="background: #222; color: white; border: 1px solid #555; padding: 5px;">
            <option>Buscando puertos...</option>
        </select>
        <button onclick="buscarPuertos()" style="background: #8A2BE2; border: none; color: white; padding: 5px 10px; cursor: pointer;">üîÑ</button>
        <div style="width: 1px; height: 20px; background: #444;"></div>
        <button id="btnStart" onclick="startStream()" class="btn-ctrl btn-start">INICIAR TRANSMISI√ìN üì°</button>
        <button id="btnStop" onclick="stopStream()" class="btn-ctrl btn-stop">DETENER TRANSMISI√ìN ‚èπÔ∏è</button>
    </div>
    {% endif %}
</div>

<!-- GR√ÅFICAS -->
<div class="flex-container">
    <div class="item" style="flex: 0 0 55%; display: flex; flex-direction: column;">
        <h3 style="border-bottom: 1px solid #444; width: 100%; text-align: center; padding-bottom: 5px; margin-bottom: 0;">AMBIENTE</h3>
        <div style="display: flex; width: 100%; justify-content: space-between; align-items: center; flex-grow: 1;">
            <div class="donutBox"><h4>Temp(C¬∞)</h4><canvas id="myChart5"></canvas></div>
            <div class="donutBox"><h4>Hum(%)</h4><canvas id="myChart6"></canvas></div>
            <div class="donutBox"><h4>Pres(hPa)</h4><canvas id="myChart7"></canvas></div>
            <div class="donutBox"><h4>CO2(ppm)</h4><canvas id="myChart8"></canvas></div>
        </div>
    </div>
    <div class="item" style="flex: 1;">
        <h3 style="border-bottom: 1px solid #444; width: 100%; text-align: center; padding-bottom: 5px;">ESTADO DE VUELO</h3>
        <div style="display: flex; width: 100%; gap: 20px; margin-bottom: 10px;">
            <div style="width: 50%;">
                <div class="coorBox"><p>Apogeo:</p><p id="p-apo">0 m</p></div>
                <div class="coorBox"><p>Ev.1:</p><p id="p-arr">---</p></div>
                <div class="coorBox"><p>Ev.2:</p><p id="p-mai">---</p></div>
            </div>
            <div style="width: 50%;">
                <div class="coorBox"><p>LAT:</p><p id="plat">0.000</p></div>
                <div class="coorBox"><p>LON:</p><p id="plon">0.000</p></div>
            </div>
        </div>
        <div class="lineBox" style="width:100%; height: 200px; margin-top: 5px;"><canvas id="myChart9"></canvas></div>
    </div>
</div>

<div class="flex-container">
    <div class="item" style="flex-direction: row; justify-content: space-around; padding: 10px;">
        <div class="chartBox"><h3>Velocidad</h3><canvas id="myChart"></canvas></div>
        <div class="chartBox"><h3>Vel. Angular</h3><canvas id="myChart2"></canvas></div>
        <div class="chartBox"><h3>Aceleraci√≥n</h3><canvas id="myChart3"></canvas></div>
        <div class="chartBox"><h3>Acel. Angular</h3><canvas id="myChart4"></canvas></div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script>if(typeof io === 'undefined') { document.write('<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"><\/script>'); }</script>
<script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>
<script>if(typeof Chart === 'undefined') { document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"><\/script>'); }</script>

<script>
    var socket;
    var MISSION_ID = "{{ mision.ID_Mision }}";
    var MY_USER_ID = String("{{ session.get('user_id') }}"); 
    var IS_ADMIN = {{ 'true' if es_admin else 'false' }};
    var debugEl = document.getElementById('debugInfo');
    var chartsReady = false;
    var myChart, myChart2, myChart3, myChart4, myChart5, myChart6, myChart7, myChart8, myChart9;
    
    // --- INICIALIZACI√ìN GR√ÅFICAS ---
    try {
        if (typeof Chart === 'undefined') throw new Error("Librer√≠a Chart no encontrada");

        const gaugeChartText = { id: 'gaugeChartText', afterDatasetsDraw(chart) { const { ctx, data } = chart; ctx.save(); const score = data.datasets[0].data[0]; const x = chart.getDatasetMeta(0).data[0].x; const y = chart.getDatasetMeta(0).data[0].y; ctx.font = 'bold 16px Orbitron'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText(score, x, y - 20); ctx.restore(); } };
        const gaugeChartText2 = { id: 'gaugeChartText2', afterDatasetsDraw(chart) { const { ctx, data } = chart; ctx.save(); const score = data.datasets[0].data[0]; const x = chart.getDatasetMeta(0).data[0].x; const y = chart.getDatasetMeta(0).data[0].y; ctx.font = 'bold 16px Orbitron'; ctx.fillStyle = '#ccc'; ctx.textAlign = 'center'; ctx.fillText(score, x, y + 5); ctx.restore(); } };
        const ctxTemp = document.createElement('canvas').getContext('2d'); const gradient = ctxTemp.createLinearGradient(0, 0, 100, 0); gradient.addColorStop(0, '#E6E6FA'); gradient.addColorStop(0.5, '#8A2BE2'); gradient.addColorStop(1, '#4B0082');
        
        function createData(label, value, total, circ, rot) { return { labels: [label, 'Empty'], datasets: [{ data: [value, total - value], backgroundColor: [gradient, 'rgba(255, 255, 255, 0.1)'], borderWidth: 0, cutout: '75%', circumference: circ, rotation: rot, borderRadius: 5 }] }; }
        function config(data, plugin) { return { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, animation: { duration: 0 }, layout: { padding: 10 } }, plugins: [plugin] }; }

        myChart = new Chart(document.getElementById('myChart'), config(createData('Speed', 0, 100, 180, 270), gaugeChartText));
        myChart2 = new Chart(document.getElementById('myChart2'), config(createData('AngSpeed', 0, 100, 180, 270), gaugeChartText));
        myChart3 = new Chart(document.getElementById('myChart3'), config(createData('Accel', 0, 100, 180, 270), gaugeChartText));
        myChart4 = new Chart(document.getElementById('myChart4'), config(createData('AngAccel', 0, 100, 180, 270), gaugeChartText));
        myChart5 = new Chart(document.getElementById('myChart5'), config(createData('Temp', 0, 50, 360, 0), gaugeChartText2));
        myChart6 = new Chart(document.getElementById('myChart6'), config(createData('Hum', 0, 100, 360, 0), gaugeChartText2));
        myChart7 = new Chart(document.getElementById('myChart7'), config(createData('Press', 0, 1100, 360, 0), gaugeChartText2));
        myChart8 = new Chart(document.getElementById('myChart8'), config(createData('CO2', 0, 1000, 360, 0), gaugeChartText2));
        myChart9 = new Chart(document.getElementById('myChart9'), { type: 'line', data: { labels: [], datasets: [{ label: 'Altitud', data: [], borderColor: '#8A2BE2', backgroundColor: 'rgba(138, 43, 226, 0.2)', borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { ticks: { color: '#ccc', font: {size: 10} }, grid: { color: '#333' } } }, plugins: { legend: { display: false } }, animation: { duration: 0 } } });
        chartsReady = true;
    } catch(e) { document.getElementById('chartError').style.display = 'block'; }

    function updateDonut(chart, value, total) { if(chartsReady && chart) { chart.data.datasets[0].data = [value, total - value]; chart.update('none'); } }
    function updateLine(chart, label, value) { if(chartsReady && chart) { if (chart.data.labels.length > 50) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); } chart.data.labels.push(label); chart.data.datasets[0].data.push(value); chart.update('none'); } }

    // --- SOCKETS ---
    try { socket = io(); } catch(e) { debugEl.innerText = "Error socket"; }

    if(socket) {
        socket.on('connect', function() {
            document.getElementById('statusMsg').innerText = "ONLINE ‚úÖ";
            document.getElementById('statusMsg').style.color = "#0f0";
            socket.emit('join', { mission_id: MISSION_ID });
        });

        socket.on('status_msg', function(data) {
            document.getElementById('statusMsg').innerText = ">> " + data.msg;
        });

        // --- CONTROL DE BOTONES ---
        socket.on('mission_started', function(data) {
            if (data.mission_id == MISSION_ID) {
                if (String(data.owner_id) === MY_USER_ID) {
                    activarModoBroadcaster();
                }
            }
        });

        socket.on('you_are_broadcaster', function(data) {
            if(data.val) activarModoBroadcaster();
        });

        socket.on('stream_ended', function() {
            desactivarModoBroadcaster();
        });

socket.on('telemetria', function(t) {
            // DEBUG: Ver en consola qu√© llega exactamente
            console.log("Datos recibidos:", t); 

            debugEl.innerText = "Rx: " + new Date().toLocaleTimeString();
            
            // Textos Simples
            if(t.latitud !== undefined) document.getElementById('plat').textContent = t.latitud.toFixed(5);
            if(t.longitud !== undefined) document.getElementById('plon').textContent = t.longitud.toFixed(5);
            if(t.apogeo !== undefined) document.getElementById('p-apo').textContent = t.apogeo + ' m';
            
            // Eventos Booleanos
            const pArr = document.getElementById('p-arr'); 
            if(t.evento_1 !== undefined) { 
                pArr.textContent = t.evento_1 ? "ACTIVO" : "---"; 
                pArr.style.color = t.evento_1 ? "#00FF00" : "#FFFFFF"; 
            }
            
            const pMai = document.getElementById('p-mai'); 
            if(t.evento_2 !== undefined) { 
                pMai.textContent = t.evento_2 ? "ACTIVO" : "---"; 
                pMai.style.color = t.evento_2 ? "#FF4500" : "#FFFFFF"; 
            }

            // --- ACTUALIZACI√ìN DE GR√ÅFICAS DONUT ---
            
            // Velocidad (Python env√≠a: 'velocidad') -> OK
            if(t.velocidad !== undefined) updateDonut(myChart, t.velocidad, 100);
            
            // Vel. Angular (Python env√≠a: 'velocidad_ang') -> OK
            if(t.velocidad_ang !== undefined) updateDonut(myChart2, t.velocidad_ang, 100);
            
            // Aceleraci√≥n (Python env√≠a: 'aceleracion') -> OK
            if(t.aceleracion !== undefined) updateDonut(myChart3, t.aceleracion, 100);
            
            // --- AQU√ç ESTABA EL ERROR ---
            // Antes ten√≠as 't.aceleracion_ang', pero Python env√≠a 't.acc_ang'
            if(t.acc_ang !== undefined) updateDonut(myChart4, t.acc_ang, 100);

            // Ambiente
            if(t.temperatura !== undefined) updateDonut(myChart5, t.temperatura, 50);
            if(t.humedad !== undefined) updateDonut(myChart6, t.humedad, 100);
            if(t.presion !== undefined) updateDonut(myChart7, t.presion, 1200);
            if(t.co2 !== undefined) updateDonut(myChart8, t.co2, 1000);
            
            // Gr√°fica de L√≠nea (Altitud)
            if(t.altitud !== undefined) { 
                const timeLabel = new Date().toLocaleTimeString().split(' ')[0]; 
                updateLine(myChart9, timeLabel, t.altitud); 
            }
        });
    }

    function activarModoBroadcaster() {
        if (IS_ADMIN) {
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'inline-block';
            document.getElementById('comPort').disabled = true;
            window.onbeforeunload = function() { return "Transmisi√≥n activa. ¬øSalir?"; };
        }
    }

    function desactivarModoBroadcaster() {
        if (IS_ADMIN) {
            document.getElementById('btnStart').style.display = 'inline-block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('comPort').disabled = false;
            window.onbeforeunload = null;
        }
    }

    if (IS_ADMIN) {
        document.addEventListener('DOMContentLoaded', buscarPuertos);
        function buscarPuertos() { socket.emit('buscar_puertos', { mission_id: MISSION_ID }); }
        socket.on('lista_puertos', function(lista) { const sel = document.getElementById('comPort'); sel.innerHTML = ""; if(lista.length === 0) sel.add(new Option("Sin respuesta", "")); lista.forEach(p => { sel.add(new Option(p.desc, p.device)); }); });
        function startStream() { const puerto = document.getElementById('comPort').value; if(!puerto) return alert("Selecciona puerto"); socket.emit('start_stream_mission', { mission_id: MISSION_ID, puerto: puerto }); }
        function stopStream() { if(confirm("¬øDetener?")) socket.emit('stop_stream_mission', { mission_id: MISSION_ID }); }
    }
</script>
{% endblock %}