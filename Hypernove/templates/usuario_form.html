{% extends "base.html" %}
{% block title %}{{ 'Nuevo' if accion == 'crear' else 'Editar' }} Usuario{% endblock %}

{% block content %}
<style>
    /* Estructura Principal */
    .form-card { 
        max-width: 500px; 
        margin: 40px auto; 
        background: #1a1a1a; 
        padding: 30px; 
        border-radius: 15px; 
        border: 1px solid #00ccff; 
        box-shadow: 0 0 30px rgba(0, 204, 255, 0.15); 
    }
    h2 { text-align: center; color: white; font-family: 'Orbitron'; margin-bottom: 30px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; color: #aaa; margin-bottom: 8px; font-size: 0.9rem; }
    
    /* Inputs y Selects */
    input, select { 
        width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #444; 
        color: white; border-radius: 5px; transition: 0.3s; 
    }
    input:focus, select:focus { 
        border-color: #00ccff; outline: none; box-shadow: 0 0 10px rgba(0, 204, 255, 0.2); 
    }
    
    /* Validación Dinámica de Contraseña */
    .politicas-lista { list-style: none; padding: 0; margin: 10px 0; }
    .politica-item { font-size: 0.8rem; color: #555; margin-bottom: 4px; transition: 0.3s; }
    .politica-item.cumplido { color: #8bff8b; }
    
    /* Estados de Input */
    .input-error { border-color: #dc3545 !important; box-shadow: 0 0 8px rgba(220, 53, 69, 0.4) !important; }
    .input-success { border-color: #28a745 !important; box-shadow: 0 0 8px rgba(40, 167, 69, 0.4) !important; }

    /* Botones */
    .btn-save { 
        width: 100%; padding: 15px; background: linear-gradient(45deg, #00ccff, #0066ff); 
        color: white; border: none; border-radius: 5px; font-family: 'Orbitron'; 
        font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; 
    }
    .btn-save:hover:not(:disabled) { filter: brightness(1.2); transform: scale(1.02); }
    .btn-save:disabled { background: #333; cursor: not-allowed; filter: grayscale(1); opacity: 0.5; }
    .btn-cancel { display: block; text-align: center; margin-top: 15px; color: #666; text-decoration: none; }
    .btn-cancel:hover { color: white; }

    /* Mensaje de Error con Contorno */
    .server-alert {
        background-color: rgba(220, 53, 69, 0.15); 
        border: 2px solid #dc3545;                 /* CONTORNO SÓLIDO */
        color: #ff6b6b;                            
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
    }
    .success-alert {
        background-color: rgba(40, 167, 69, 0.15);
        border: 2px solid #28a745;                 /* CONTORNO VERDE */
        color: #8bff8b;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-align: center;
    }
</style>

<div class="form-card">
    <h2>{{ 'REGISTRAR' if accion == 'crear' else 'EDITAR' }} USUARIO</h2>

    <div id="mensaje-frontend">
        {% if error_email %}
            <div class="server-alert">Error: El correo electrónico ya está registrado.</div>
        {% endif %}
    </div>

    <form method="POST" id="usuarioForm">
        <div class="form-group">
            <label>Nombre Completo</label>
            <input type="text" name="nombre" 
                   value="{{ temp_nombre if temp_nombre else (usuario.Nombre if usuario else '') }}" 
                   required autofocus>
        </div>
        
        <div class="form-group">
            <label>Correo Electrónico</label>
            <input type="email" name="email" 
                   value="{{ temp_email if temp_email else (usuario.email if usuario else '') }}" 
                   required placeholder="ejemplo@dominio.com">
        </div>

        <div class="form-group">
            <label>Rol de Sistema</label>
            <select name="rol">
                {% set rol_actual = temp_rol if temp_rol else (usuario.Rol if usuario else 'invitado') %}
                <option value="invitado" {{ 'selected' if rol_actual == 'invitado' }}>Invitado</option>
                <option value="mantenimiento" {{ 'selected' if rol_actual == 'mantenimiento' }}>Mantenimiento</option>
                <option value="admin" {{ 'selected' if rol_actual == 'admin' }}>Administrador</option>
            </select>
        </div>

        {% if accion == 'crear' %}
        <div class="form-group">
            <label>Contraseña</label>
            <input type="password" name="password" id="password" required>
            <ul class="politicas-lista">
                <li id="req-longitud" class="politica-item">○ Mínimo 8 caracteres</li>
                <li id="req-numero" class="politica-item">○ Al menos un número</li>
                <li id="req-simbolo" class="politica-item">○ Al menos un símbolo (!@#$...)</li>
            </ul>
        </div>

        <div class="form-group">
            <label>Confirmar Contraseña</label>
            <input type="password" id="confirm_password" required>
            <p id="msg-coincide" style="font-size: 0.8rem; margin-top: 5px; color: #555;">○ Las contraseñas deben coincidir</p>
        </div>
        {% else %}
        <div class="form-group" style="border-top: 1px solid #333; padding-top: 20px; margin-top: 20px;">
            <label>Seguridad de la Cuenta</label>
            <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px;">
                Por seguridad, la contraseña no se puede editar manualmente.
            </p>
            <a href="{{ url_for('forgot_password') }}" class="btn-save" 
               style="display: block; text-decoration: none; text-align: center; background: #5D3FD3; font-size: 0.8rem; padding: 10px;">
                ENVIAR ENLACE DE RESTABLECIMIENTO
            </a>
        </div>
        {% endif %}

        <button type="submit" class="btn-save" id="btnSubmit">GUARDAR USUARIO</button>
        <a href="{{ url_for('usuarios_list') }}" class="btn-cancel">Cancelar</a>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('usuarioForm');
    const emailInput = document.querySelector('input[name="email"]');
    const passwordInput = document.getElementById('password');
    const mensajeContainer = document.getElementById('mensaje-frontend');

    // Función para crear la alerta con contorno
    function mostrarError(mensaje) {
        mensajeContainer.innerHTML = `<div class="server-alert">${mensaje}</div>`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 1. Limpiar mensajes cuando el usuario empiece a corregir
    const inputs = form.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('input', () => {
            mensajeContainer.innerHTML = ''; // Borra el mensaje de error
            input.classList.remove('input-error');
        });
    });

    // 2. Validación antes de enviar (Frontend)
    form.addEventListener('submit', function(e) {
        const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.(com|net|org|edu|gov|mx|io|app)$/;
        const passRegex = /^(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;

        let errorActivo = false;

        // Validar Email
        if (!emailRegex.test(emailInput.value)) {
            mostrarError("Error: Formato de correo inválido o extensión no permitida.");
            emailInput.classList.add('input-error');
            errorActivo = true;
        } 
        // Validar Password (solo si existe el campo en modo crear)
        else if (passwordInput && !passRegex.test(passwordInput.value)) {
            mostrarError("Error: La contraseña debe tener 8 caracteres, un número y un símbolo.");
            passwordInput.classList.add('input-error');
            errorActivo = true;
        }

        if (errorActivo) {
            e.preventDefault(); // Detiene el envío
        }
    });
});
</script>
{% endblock %}