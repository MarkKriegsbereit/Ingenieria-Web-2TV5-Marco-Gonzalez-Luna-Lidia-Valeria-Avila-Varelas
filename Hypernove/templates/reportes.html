{% extends "base.html" %}
{% block title %}An치lisis de Misi칩n{% endblock %}

{% block content %}
<style>
    .report-container { max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
    
    /* Selector */
    .mission-selector { background: #1a1a1a; border: 1px solid #8A2BE2; padding: 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; box-shadow: 0 0 20px rgba(138, 43, 226, 0.2); }
    .mission-selector select { background: #000; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; width: 300px; font-family: 'Roboto'; }
    .btn-load { background: #8A2BE2; color: white; border: none; padding: 10px 25px; border-radius: 5px; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; }
    .btn-load:hover { background: #7b24ca; box-shadow: 0 0 10px #8A2BE2; }
    
    /* Resumen Estad칤stico */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: rgba(20, 20, 20, 0.8); border-left: 4px solid #00ffcc; padding: 20px; border-radius: 8px; text-align: center; }
    .stat-value { font-family: 'Orbitron'; font-size: 1.8rem; color: white; margin: 10px 0; }
    .stat-label { color: #aaa; font-size: 0.9rem; }
    
    /* Cuadr칤cula de Gr치ficas Individuales */
    .charts-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
        gap: 20px; 
    }
    
    .chart-wrapper { 
        background: rgba(20, 20, 20, 0.6); 
        border: 1px solid #333; 
        border-radius: 10px; 
        padding: 15px; 
    }
    .chart-title { color: #8A2BE2; font-family: 'Orbitron'; margin-bottom: 10px; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 5px;}
    
    /* --- CORRECCI칍N DE EXPANSI칍N INFINITA --- */
    .canvas-container {
        position: relative;
        height: 300px; /* Altura fija obligatoria */
        width: 100%;
    }

    /* Estado Vac칤o */
    .empty-state { text-align: center; color: #666; margin-top: 50px; }
    .empty-icon { font-size: 4rem; display: block; margin-bottom: 20px; }


    /* --- LOADER STYLE --- */
    .loader-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(10, 10, 10, 0.9);
        display: none; /* Oculto por defecto */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(138, 43, 226, 0.2);
        border-top: 5px solid #8A2BE2; /* Color morado Hypernova */
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loader-text {
        font-family: 'Orbitron';
        color: white;
        letter-spacing: 2px;
        font-size: 1rem;
    }



</style>

<div class="report-container">

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="loader-text">PROCESANDO TELEMETR칈A...</div>
    </div>



    <div class="mission-selector">
        <div>
            <h2 style="font-family:'Orbitron'; color:white; margin:0;">AN츼LISIS DE MISI칍N</h2>
            <p style="color:#aaa; margin:5px 0 0 0;">Generaci칩n de reportes hist칩ricos</p>
        </div>
        <form method="POST" style="display:flex; gap:10px;">
            <select name="mision_id" required>
                <option value="" disabled selected>Seleccionar Misi칩n...</option>
                {% for m in misiones %}
                    <option value="{{ m.ID_Mision }}" {% if mision_actual and mision_actual.ID_Mision == m.ID_Mision %}selected{% endif %}>{{ m.Nombre_Mision }} ({{ m.Fecha }})</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn-load">CARGAR DATOS</button>
        </form>
    </div>

    {% if mision_actual %}
        <!-- 1. RESUMEN ESTAD칈STICO -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">APOGEO M츼XIMO</div>
                <div class="stat-value" style="color:#00ffcc;">{{ stats.apogeo_real }} m</div>
            </div>
            <div class="stat-card" style="border-color: #ff0055;">
                <div class="stat-label">VELOCIDAD M츼X</div>
                <div class="stat-value" style="color:#ff0055;">{{ stats.max_vel }} m/s</div>
            </div>
            <div class="stat-card" style="border-color: #ffff00;">
                <div class="stat-label">ACELERACI칍N PICO</div>
                <div class="stat-value" style="color:#ffff00;">{{ stats.max_acc }} m/s</div>
            </div>
            <div class="stat-card" style="border-color: #8A2BE2;">
                <div class="stat-label">TIEMPO DE VUELO</div>
                <div class="stat-value" style="color:#8A2BE2;">{{ stats.flight_time }}</div>
            </div>
        </div>

        <!-- 2. GR츼FICAS INDIVIDUALES -->
        <div class="charts-grid">
            <!-- VUELO -->
            <div class="chart-wrapper">
                <h3 class="chart-title">ALTITUD (m)</h3>
                <div class="canvas-container">
                    <canvas id="altChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">VELOCIDAD (m/s)</h3>
                <div class="canvas-container">
                    <canvas id="velChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">ACELERACI칍N (m/s)</h3>
                <div class="canvas-container">
                    <canvas id="accChart"></canvas>
                </div>
            </div>

            <!-- AMBIENTE -->
            <div class="chart-wrapper">
                <h3 class="chart-title">TEMPERATURA (춿C)</h3>
                <div class="canvas-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">PRESI칍N (hPa)</h3>
                <div class="canvas-container">
                    <canvas id="presChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">HUMEDAD (%)</h3>
                <div class="canvas-container">
                    <canvas id="humChart"></canvas>
                </div>
            </div>
            <div class="chart-wrapper">
                <h3 class="chart-title">CO2 (ppm)</h3>
                <div class="canvas-container">
                    <canvas id="co2Chart"></canvas>
                </div>
            </div>
        </div>

    {% else %}
        <div class="empty-state">
            <span class="empty-icon">游늵</span>
            <h3>Ninguna misi칩n seleccionada</h3>
            <p>Elige una misi칩n del men칰 superior para ver sus resultados.</p>
        </div>
    {% endif %}
</div>

<script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>


{% if mision_actual %}
<script>
    // Mostrar loader inmediatamente al hacer clic en Cargar
    document.querySelector('form').addEventListener('submit', function() {
        document.getElementById('loader').style.display = 'flex';
    });

    document.addEventListener('DOMContentLoaded', function() {
        const loader = document.getElementById('loader');
        const rawData = JSON.parse('{{ datos | safe }}');
        
        if(rawData.length > 0) {
            // Mostramos el loader mientras JS trabaja
            loader.style.display = 'flex';

            // Usamos setTimeout(0) para permitir que el DOM muestre el loader antes de bloquear el hilo principal con las gr치ficas
            setTimeout(() => {
                let dataToRender = rawData;
                const MAX_POINTS = 1000;
                
                if (rawData.length > MAX_POINTS) {
                    const step = Math.ceil(rawData.length / MAX_POINTS);
                    dataToRender = rawData.filter((_, index) => index % step === 0);
                }

                const labels = dataToRender.map(d => d.time);
                
                const commonOptions = {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    normalized: true,
                    interaction: { mode: 'index', intersect: false },
                    elements: { point: { radius: 0, hitRadius: 10 } },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#666', maxTicksLimit: 10 }, grid: { color: '#333' } },
                        y: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
                    }
                };

                function createSingleChart(id, dataKey, color, label) {
                    const ctx = document.getElementById(id);
                    if (!ctx) return;
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: dataToRender.map(d => d[dataKey]),
                                borderColor: color,
                                backgroundColor: color + '20',
                                fill: true,
                                borderWidth: 2,
                                tension: 0.1
                            }]
                        },
                        options: commonOptions
                    });
                }

                // Dibujar todas las gr치ficas
                createSingleChart('altChart', 'altitud', '#8A2BE2', 'Altitud');
                createSingleChart('velChart', 'velocidad', '#00ffcc', 'Velocidad');
                createSingleChart('accChart', 'aceleracion', '#ff8800', 'Aceleraci칩n');
                createSingleChart('tempChart', 'temperatura', '#ff4444', 'Temperatura');
                createSingleChart('presChart', 'presion', '#ffff00', 'Presi칩n');
                createSingleChart('humChart', 'humedad', '#0099ff', 'Humedad');
                createSingleChart('co2Chart', 'co2', '#00ff00', 'CO2');

                // Una vez terminadas las 7 gr치ficas, ocultamos el loader
                loader.style.display = 'none';
            }, 50);
        }
    });
</script>
{% endif %}

{% endblock %}